---
import { ThemeSwitch } from './ThemeSwitch'
import { author, footer } from '@/config.json'
import { getAllPostsWordCount } from '@/utils/content'
import { RunningDays } from './RunningDays'
import Link from './Link.astro'

const sinceYear = new Date(footer.startTime).getFullYear()
const thisYear = new Date().getFullYear()
const copyDate = sinceYear === thisYear ? thisYear : `${sinceYear} - ${thisYear}`

const wordCount = await getAllPostsWordCount()

const wordCountStr = (wordCount / 1000).toFixed(1) + 'k'
---

<footer class="relative z-1 py-8 px-4 md:px-8 border-t border-primary text-secondary text-sm">
  <div class="text-center space-y-2">
    <div>
      Powered by
      <Link href="https://astro.build/">Astro</Link>
      & Designed by
      <Link href="https://github.com/lxchapu/astro-gyoza">Gyoza</Link>
    </div>
    <div class="space-x-1">
      <span>&copy;{copyDate} <Link href="/">{author.name}</Link>.</span>
      {
        (() => {
          const path = Astro.url.pathname.replace(/\/+$/, '')
          const segments = path.split('/').filter(Boolean)
          const isCategory = segments[0] === 'categories' && segments.length === 2
          const isTag = segments[0] === 'tags' && segments.length === 2
          const rssHref = isCategory
            ? `/categories/${segments[1]}/rss.xml`
            : isTag
              ? `/tags/${segments[1]}/rss.xml`
              : '/rss.xml'
          return (
            <Link href={rssHref} id="footer-rss-link" data-no-swup>
              <i class="iconfont icon-rss" />
              <span>RSS</span>
            </Link>
          )
        })()
      }
      <Link href="/sitemap-index.xml" data-no-swup>
        <i class="iconfont icon-treasure-map"></i>
        <span>站点地图</span>
      </Link>
    </div>
    <div>
      <RunningDays client:only="react" />
      <span class="select-none opacity-50">|</span>
      <span>共撰写了 {wordCountStr} 字</span>
    </div>
  </div>
  <div class="mt-4 flex justify-center">
    <ThemeSwitch client:only="react" />
  </div>
</footer>
<script>
  function updateFooterRSS() {
    const path = window.location.pathname.replace(/\/+$/, '')
    const segments = path.split('/').filter(Boolean)
    const isCategory = segments[0] === 'categories' && segments.length === 2
    const isTag = segments[0] === 'tags' && segments.length === 2
    const rssHref = isCategory
      ? `/categories/${segments[1]}/rss.xml`
      : isTag
        ? `/tags/${segments[1]}/rss.xml`
        : '/rss.xml'
    const link = document.getElementById('footer-rss-link')
    if (link) {
      link.setAttribute('href', rssHref)
    }
  }
  updateFooterRSS()
  document.addEventListener('swup:content:replace', updateFooterRSS)
</script>
